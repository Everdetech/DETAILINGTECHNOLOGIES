<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DETAILINGTECHNOLOGIES</title>
  <style>
    body {
      margin: 0; font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5;
    }
    header {
      background-color: #1a1a2e; color: white; padding: 1.5em; position: relative;
    }
    .auth {
      position: absolute; top: 1em; right: 1em;
    }
    .auth button {
      background: #0f3460; color: white; border: none; padding: 6px 12px; margin-left: 8px;
      border-radius: 5px; cursor: pointer;
    }
    nav {
      background-color: #16213e; padding: 0.8em; text-align: center;
    }
    nav a {
      color: white; margin: 0 20px; text-decoration: none; font-weight: 500;
    }
    .container {
      max-width: 1000px; margin: auto; padding: 2em;
      display: flex; gap: 2em;
    }
    #products, #cart {
      background: white; border-radius: 10px; box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      padding: 1.5em; flex: 1; max-height: 600px; overflow-y: auto;
    }
    #products h2, #cart h2 {
      color: #1a1a2e; margin-top: 0;
    }
    .product-card {
      border-bottom: 1px solid #ddd; padding: 1em 0;
    }
    .product-card:last-child {
      border-bottom: none;
    }
    .product-card img {
      max-width: 150px; display: block; margin-bottom: 0.5em;
    }
    .product-info {
      margin-bottom: 0.5em;
    }
    .product-info h3 {
      margin: 0 0 0.3em 0;
      color: #0f3460;
    }
    button.buy-btn {
      background-color: #0f3460; color: white; border: none; padding: 6px 12px;
      cursor: pointer; border-radius: 5px;
    }
    #admin-panel {
      margin-top: 1em; padding-top: 1em; border-top: 2px solid #0f3460;
    }
    #admin-panel input, #admin-panel textarea {
      width: 100%; margin-bottom: 0.5em; padding: 0.5em;
      border-radius: 5px; border: 1px solid #ccc;
      font-size: 1em;
    }
    #admin-panel button {
      background-color: #0f3460; color: white; border: none; padding: 8px 16px;
      cursor: pointer; border-radius: 5px; font-weight: bold;
    }
    #cart ul {
      list-style: none; padding: 0;
    }
    #cart li {
      display: flex; justify-content: space-between; margin-bottom: 0.5em;
      border-bottom: 1px solid #ddd; padding-bottom: 0.3em;
    }
    #cart li button {
      background: #ff4d4d; border: none; color: white; cursor: pointer; border-radius: 5px; padding: 2px 8px;
    }
    footer {
      background-color: #0f3460; color: white; text-align: center; padding: 1em; margin-top: 2em;
    }
  </style>
</head>
<body>

<header>
  <h1>DETAILINGTECHNOLOGIES</h1>
  <div class="auth" id="auth-buttons">
    <button onclick="showLogin()">Iniciar Sesión</button>
    <button onclick="showRegister()">Registrarse</button>
  </div>
  <div class="auth" id="user-info" style="display:none;">
    <span id="user-email" style="color:#ccc;"></span>
    <button onclick="logout()">Cerrar sesión</button>
  </div>
</header>

<nav>
  <a href="#products">Productos</a>
  <a href="#cart">Carrito</a>
  <a href="#contacto">Contacto</a>
</nav>

<div class="container">
  <section id="products">
    <h2>Productos</h2>
    <div id="product-list"></div>
    <div id="admin-panel" style="display:none;">
      <h3>Panel Administrador</h3>
      <input type="text" id="prod-name" placeholder="Nombre producto" />
      <textarea id="prod-desc" placeholder="Descripción"></textarea>
      <input type="number" id="prod-price" placeholder="Precio" min="0" step="0.01" />
      <input type="file" id="prod-img" accept="image/*" />
      <button onclick="addProduct()">Agregar Producto</button>
    </div>
  </section>

  <section id="cart">
    <h2>Carrito de Compras</h2>
    <ul id="cart-items"></ul>
    <strong>Total: $<span id="cart-total">0.00</span></strong>
  </section>
</div>

<section id="contacto" style="max-width:1000px; margin:auto; padding:1em; background:#fff; border-radius:10px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); margin-top: 2em;">
  <h2>Contacto</h2>
  <p>📍 Dirección: Envios a Domicilio<br>📞 Tel: +504 9275-8062<br>📧 Email: contacto@detailingtechnologies.com</p>
</section>

<footer>
  &copy; 2025 DETAILINGTECHNOLOGIES. Todos los derechos reservados.
</footer>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
    signOut, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, collection, getDocs, addDoc, deleteDoc, doc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getStorage, ref, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  // Tu configuración Firebase (con App ID incluido)
  const firebaseConfig = {
    apiKey: "AIzaSyDTq6tg23FH6o-msd8smbvsoEPgH6hW-Lo",
    authDomain: "detailingtechnologies-1a8b4.firebaseapp.com",
    projectId: "detailingtechnologies-1a8b4",
    storageBucket: "detailingtechnologies-1a8b4.appspot.com",
    messagingSenderId: "1016910506813",
    appId: "1:1016910506813:web:7af1bc876bc41f616ef354"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getFirestore();
  const storage = getStorage();

  const ADMIN_EMAIL = "admin@detailing.com";  // Cambia esto al correo real del admin

  // Elementos UI
  const productList = document.getElementById("product-list");
  const cartItems = document.getElementById("cart-items");
  const cartTotalEl = document.getElementById("cart-total");
  const authButtons = document.getElementById("auth-buttons");
  const userInfo = document.getElementById("user-info");
  const userEmailDisplay = document.getElementById("user-email");
  const adminPanel = document.getElementById("admin-panel");

  let cart = [];

  // Mostrar login prompt
  window.showLogin = async () => {
    const email = prompt("Correo:");
    if(!email) return alert("Email es requerido");
    const password = prompt("Contraseña:");
    if(!password) return alert("Contraseña es requerida");
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch(e) {
      alert("Error al iniciar sesión: " + e.message);
    }
  };

  // Mostrar registro prompt
  window.showRegister = async () => {
    const email = prompt("Correo para registro:");
    if(!email) return alert("Email es requerido");
    const password = prompt("Contraseña (mínimo 6 caracteres):");
    if(!password || password.length < 6) return alert("Contraseña inválida");
    try {
      await createUserWithEmailAndPassword(auth, email, password);
      alert("Registro exitoso, ya puedes iniciar sesión");
    } catch(e) {
      alert("Error en registro: " + e.message);
    }
  };

  // Cerrar sesión
  window.logout = async () => {
    await signOut(auth);
  };

  // Cargar productos desde Firestore
  async function loadProducts() {
    const querySnapshot = await getDocs(collection(db, "productos"));
    productList.innerHTML = "";
    querySnapshot.forEach(docSnap => {
      const data = docSnap.data();
      const prodCard = document.createElement("div");
      prodCard.className = "product-card";
      prodCard.innerHTML = `
        <h3>${data.nombre}</h3>
        <img src="${data.imagenURL || ''}" alt="${data.nombre}" />
        <div class="product-info">
          <p>${data.descripcion}</p>
          <p><strong>Precio:</strong> $${parseFloat(data.precio).toFixed(2)}</p>
          <button class="buy-btn" data-id="${docSnap.id}">Agregar al carrito</button>
        </div>
      `;
      productList.appendChild(prodCard);
    });

    // Añadir evento para botones de compra
    document.querySelectorAll(".buy-btn").forEach(button => {
      button.addEventListener("click", () => {
        const prodId = button.getAttribute("data-id");
        addToCart(prodId);
      });
    });
  }

  // Añadir producto al carrito
  async function addToCart(prodId) {
    // Busca producto en Firestore para añadir info
    const prodRef = doc(db, "productos", prodId);
    const prodSnap = await prodRef.get?.() || await getDocs(collection(db, "productos")); // fallback
    const prodDoc = await (await fetchProductById(prodId));
    if (!prodDoc) return alert("Producto no encontrado");
    cart.push(prodDoc);
    renderCart();
  }

  // Para obtener producto por ID (Firestore no tiene get by id directo, hacemos fetch)
  async function fetchProductById(id) {
    const querySnapshot = await getDocs(collection(db, "productos"));
    let product = null;
    querySnapshot.forEach(docSnap => {
      if(docSnap.id === id) product = {...docSnap.data(), id: docSnap.id};
    });
    return product;
  }

  // Renderizar carrito
  function renderCart() {
    cartItems.innerHTML = "";
    let total = 0;
    cart.forEach((item, i) => {
      total += Number(item.precio);
      const li = document.createElement("li");
      li.innerHTML = `
        ${item.nombre} - $${Number(item.precio).toFixed(2)}
        <button onclick="removeFromCart(${i})">X</button>
      `;
      cartItems.appendChild(li);
    });
    cartTotalEl.textContent = total.toFixed(2);
  }

  // Quitar del carrito
  window.removeFromCart = (index) => {
    cart.splice(index, 1);
    renderCart();
  };

  // Añadir producto nuevo (solo admin)
  window.addProduct = async () => {
    const nombre = document.getElementById("prod-name").value.trim();
    const descripcion = document.getElementById("prod-desc").value.trim();
    const precio = parseFloat(document.getElementById("prod-price").value);
    const imgInput = document.getElementById("prod-img");
    if (!nombre || !descripcion || !precio || precio <= 0 || imgInput.files.length === 0) {
      return alert("Completa todos los campos correctamente");
    }

    // Subir imagen a Storage
    const file = imgInput.files[0];
    const imgRef = ref(storage, `productos/${file.name}_${Date.now()}`);
    try {
      const uploadResult = await uploadBytes(imgRef, file);
      const url = await getDownloadURL(uploadResult.ref);

      // Guardar producto en Firestore
      await addDoc(collection(db, "productos"), {
        nombre,
        descripcion,
        precio,
        imagenURL: url,
        createdAt: serverTimestamp()
      });

      alert("Producto agregado exitosamente!");
      // Limpiar campos
      document.getElementById("prod-name").value = "";
      document.getElementById("prod-desc").value = "";
      document.getElementById("prod-price").value = "";
      imgInput.value = "";

      // Recargar productos
      loadProducts();
    } catch (e) {
      alert("Error al subir imagen o guardar producto: " + e.message);
    }
  };

  // Mostrar/Ocultar panel admin segun usuario
  onAuthStateChanged(auth, user => {
    if(user) {
      authButtons.style.display = "none";
      userInfo.style.display = "block";
      userEmailDisplay.textContent = user.email;
      if(user.email === ADMIN_EMAIL) {
        adminPanel.style.display = "block";
      } else {
        adminPanel.style.display = "none";
      }
      loadProducts();
    } else {
      authButtons.style.display = "block";
      userInfo.style.display = "none";
      adminPanel.style.display = "none";
      productList.innerHTML = "<p>Por favor inicia sesión para ver productos.</p>";
      cart = [];
      renderCart();
    }
  });

  // Cargar productos inicial
  loadProducts();

</script>

</body>
</html>
